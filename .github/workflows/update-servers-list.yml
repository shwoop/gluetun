name: Update servers list
on:
  pull_request:
  schedule:
    - cron: "11 3 1 */2 *" # Run at 03:11 on the 1st of every 2nd month
jobs:
  check-for-updates:
    # if: github.repository == 'qdm12/gluetun'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
    steps:
      - uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Update servers list
        run: |
          STORAGE_FILEPATH=/tmp/sfp go run ./cmd/gluetun/main.go update -all -maintainer -minratio 0.2

  create-pr:
    runs-on: ubuntu-latest
    needs: [check-for-updates]
    permissions:
      actions: read
      contents: read
    steps:
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.UPDATE_SERVERS_LIST_PAT }}
          title: Update servers list
          body: This Auto Generated PR updates the servers list.
          branch: bot/update-servers-list
          base: master
          # todo: add labels

  merge-pr:
    runs-on: ubuntu-latest
    needs: [create-pr]
    permissions:
      actions: read
      contents: read
    steps:
      - name: Enable auto-merge
        run: |
          gh pr merge ${{ needscreate-pr.pull-request-number }} --auto --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
